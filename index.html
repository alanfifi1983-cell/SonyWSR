<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SONY ç¶“éŠ·å•†é€±å ±è¡¨ç³»çµ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .cursor-wait { cursor: wait; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, writeBatch, getDocs, deleteDoc, updateDoc, where } from 'firebase/firestore';
        
        // Ensure all icons used are imported
        // Removed LockKeyhole as it caused an error, replaced usage with Lock
        import { 
            BarChart3, Save, Upload, FileSpreadsheet, Database, Users, LogOut, ChevronLeft, ChevronRight, 
            Search, Plus, ArrowDownToLine, Lock, FileText, FileUp, AlertCircle, XCircle, CheckCircle, 
            Trash2, AlertTriangle, Loader2, RefreshCw, Eye, EyeOff, UserCog, Key, RotateCcw, ShieldAlert, X, Eraser, Bug, Terminal,
            Sigma, Send, ClipboardList, Download
        } from 'lucide-react';

        // --- Firebase Configuration & Initialization ---
        const userProvidedConfig = { 
            apiKey: "AIzaSyBWUoQUq8F5nNbz4hz6DY_OL4lzo6Diqi4",
            authDomain: "sonywsr2.firebaseapp.com",
            projectId: "sonywsr2",
            storageBucket: "sonywsr2.firebasestorage.app",
            messagingSenderId: "587532959086",
            appId: "1:587532959086:web:c16f654bf230add136557f"
        };

        const firebaseConfig = userProvidedConfig;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = 'default-app-id';

        // --- Helpers ---
        const cleanStr = (str) => String(str || '').trim();
        const cleanKey = (str) => cleanStr(str).toUpperCase().replace(/[^A-Z0-9-]/g, '_');

        const generateProductKey = (internal, pos, pn) => {
            if (internal && cleanStr(internal).length > 0) return cleanKey(internal);
            if (pos && cleanStr(pos).length > 0 && !cleanStr(pos).includes('E+')) return cleanKey(pos);
            if (pn && cleanStr(pn).length > 0) return cleanKey(pn);
            return 'UNKNOWN_KEY';
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDate() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { year: d.getUTCFullYear(), week: weekNo };
        };

        const INITIAL_DATE = new Date(); 
        const getWeekString = (y, w) => `${y}-W${w.toString().padStart(2, '0')}`;
        
        // Helper to get formatted date range string "MM/DD~MM/DD"
        const getDateRangeOfWeek = (w, y) => {
            const d = (1 + (w - 1) * 7);
            const date = new Date(y, 0, d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(date.setDate(diff));
            const end = new Date(date.setDate(start.getDate() + 6));
            return `${(start.getMonth()+1).toString().padStart(2,'0')}/${start.getDate().toString().padStart(2,'0')}~${(end.getMonth()+1).toString().padStart(2,'0')}/${end.getDate().toString().padStart(2,'0')}`;
        };

        // Helper to get Month name (e.g., "Dec") from week number
        const getMonthFromWeek = (w, y) => {
            const d = (1 + (w - 1) * 7);
            const date = new Date(y, 0, d);
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return monthNames[date.getMonth()];
        };

        const getPrevWeekStr = (weekStr) => {
            if (!weekStr) return '';
            const [yStr, wStr] = weekStr.split('-W');
            const y = parseInt(yStr);
            const w = parseInt(wStr);
            
            const d = (1 + (w - 1) * 7);
            const date = new Date(y, 0, d);
            date.setDate(date.getDate() - 7);
            
            const nw = getWeekNumber(date);
            return getWeekString(nw.year, nw.week);
        };

        // --- Data Normalizer (Fix for Flat vs Nested Structure) ---
        const normalizeReportData = (docData) => {
            if (!docData) return {};

            // æƒ…æ³ 1: æ¨™æº–å·¢ç‹€ç‰©ä»¶ (items: { Key: { in: 1 } })
            if (docData.items && typeof docData.items === 'object' && !Array.isArray(docData.items)) {
                return docData.items;
            }

            // æƒ…æ³ 2: æ‰å¹³åŒ– Key ("items.Key.in": 1)
            const items = {};
            Object.keys(docData).forEach(key => {
                if (key.startsWith('items.')) {
                    // key é¡ä¼¼ "items.C202000042.in"
                    const parts = key.split('.'); 
                    if (parts.length === 3) {
                        const prodKey = parts[1]; // "C202000042"
                        const field = parts[2];   // "in"
                        
                        if (!items[prodKey]) items[prodKey] = {};
                        items[prodKey][field] = docData[key];
                    }
                }
            });
            
            return items;
        };

        // --- Shared Components ---

        const ConfirmModal = ({ title, message, onConfirm, onCancel, confirmText = "ç¢ºå®š", confirmColor = "blue" }) => (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
                <div className="bg-white rounded-lg p-6 w-96 shadow-xl">
                    <h3 className="text-lg font-bold mb-3 flex items-center text-gray-800"><ShieldAlert className="mr-2 text-yellow-500" size={24}/> {title}</h3>
                    <div className="text-sm text-gray-600 mb-6 whitespace-pre-wrap">{message}</div>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded border">å–æ¶ˆ</button>
                        <button onClick={onConfirm} className={`px-4 py-2 text-white rounded font-bold shadow-sm ${confirmColor==='red'?'bg-red-600 hover:bg-red-700':'bg-blue-600 hover:bg-blue-700'}`}>{confirmText}</button>
                    </div>
                </div>
            </div>
        );

        const MessageModal = ({ title, message, onClose, type = "info" }) => (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
                <div className="bg-white rounded-lg p-6 w-[500px] shadow-xl max-h-[80vh] flex flex-col">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className={`text-lg font-bold flex items-center ${type==='error'?'text-red-600':'text-gray-800'}`}>{type==='error'?<AlertCircle className="mr-2"/>:<CheckCircle className="mr-2 text-green-500"/>}{title}</h3>
                        <button onClick={onClose}><X size={20} className="text-gray-400 hover:text-gray-600"/></button>
                    </div>
                    <div className="text-sm text-gray-600 mb-6 whitespace-pre-wrap overflow-y-auto flex-1 p-3 bg-gray-100 rounded border border-gray-300 font-mono break-all">{message}</div>
                    <div className="flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">é—œé–‰</button></div>
                </div>
            </div>
        );

        const NavButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex items-center space-x-2 px-4 py-2 rounded transition-colors ${active ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`}>
                {icon} <span>{label}</span>
            </button>
        );

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        if (userData.password === password) {
                            onLogin({ ...userData, uid: username }); 
                            return;
                        } else {
                            setError('å¯†ç¢¼éŒ¯èª¤');
                        }
                    } else {
                        if (username === 'admin' && password === 'admin') {
                            const adminData = { username: 'admin', password: 'admin', role: 'admin', name: 'ç³»çµ±ç®¡ç†å“¡', erp_code: '' };
                            onLogin({ ...adminData, uid: 'admin' });
                            return;
                        }
                        setError('å¸³è™Ÿä¸å­˜åœ¨');
                    }
                } catch (err) {
                    console.error(err);
                    setError(`ç™»å…¥ç³»çµ±ç™¼ç”ŸéŒ¯èª¤: ${err.message} (è«‹æª¢æŸ¥ Firebase Console æ˜¯å¦é–‹å•ŸåŒ¿åç™»å…¥åŠ Firestore è¦å‰‡)`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-black text-white inline-block px-4 py-2 text-2xl font-bold tracking-widest mb-2">SONY</div>
                            <h2 className="text-xl font-semibold text-gray-700">ç¶“éŠ·å•†é€±å ±è¡¨ç³»çµ±</h2>
                            <p className="text-sm text-gray-500 mt-2">2026 å¹´åº¦ç³»çµ± (Connected to: sonywsr2)</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¸³è™Ÿ (User ID)</label>
                                <input 
                                    type="text" 
                                    required
                                    className="w-full border border-gray-300 rounded p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                    value={username}
                                    onChange={e => setUsername(e.target.value)}
                                    placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼ (Password)</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full border border-gray-300 rounded p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded text-sm flex items-center">
                                    <AlertCircle size={16} className="mr-2"/> {error}
                                </div>
                            )}

                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-black text-white py-3 rounded-md font-bold hover:bg-gray-800 transition-colors flex justify-center items-center"
                            >
                                {loading ? <Loader2 className="animate-spin" /> : 'ç™»å…¥ç³»çµ±'}
                            </button>
                            
                            <div className="text-center text-xs text-gray-400 mt-4">
                                é¦–æ¬¡ç™»å…¥é è¨­ Admin å¸³è™Ÿ: admin / admin
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Manager Components ---

        const AccountManager = ({ accounts }) => {
            const [formData, setFormData] = useState({ username: '', password: '', name: '', erp_code: '', role: 'dealer' });
            const [isEditing, setIsEditing] = useState(false);
            const [msgModal, setMsgModal] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.username) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', formData.username), formData);
                    setMsgModal({ title: "æˆåŠŸ", message: isEditing ? 'å¸³è™Ÿæ›´æ–°æˆåŠŸ' : 'å¸³è™Ÿæ–°å¢æˆåŠŸ', type: "success" });
                    setFormData({ username: '', password: '', name: '', erp_code: '', role: 'dealer' });
                    setIsEditing(false);
                } catch (e) {
                    setMsgModal({ title: "å¤±æ•—", message: 'å„²å­˜å¤±æ•—: ' + e.message, type: "error" });
                }
            };

            const handleEdit = (acc) => {
                setFormData(acc);
                setIsEditing(true);
            };

            const confirmDelete = (username) => {
                setModalConfig({
                    title: "åˆªé™¤ç¢ºèª",
                    message: `ç¢ºå®šåˆªé™¤å¸³è™Ÿ ${username}ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
                    confirmText: "ç¢ºèªåˆªé™¤",
                    confirmColor: "red",
                    onConfirm: () => {
                        setModalConfig(null);
                        handleDelete(username);
                    }
                });
            };

            const handleDelete = async (username) => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username));
                } catch (e) {
                    setMsgModal({ title: "å¤±æ•—", message: 'åˆªé™¤å¤±æ•—: ' + e.message, type: "error" });
                }
            };

            const confirmResetSystem = () => {
                setModalConfig({
                    title: "å±éšªæ“ä½œï¼šé‡ç½®ç³»çµ±",
                    message: "æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ã€Œç”¢å“è³‡æ–™ã€èˆ‡ã€Œé€±å ±è¡¨ç´€éŒ„ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼åƒ…ä¿ç•™å¸³è™Ÿè¨­å®šã€‚\n\nå»ºè­°åœ¨è³‡æ–™åº«éæ–¼æ··äº‚æ™‚ä½¿ç”¨ã€‚",
                    confirmText: "ç¢ºèªé‡ç½®",
                    confirmColor: "red",
                    onConfirm: () => {
                        setModalConfig(null);
                        resetSystem();
                    }
                });
            };

            const resetSystem = async () => {
                const batch = writeBatch(db);
                let deletedCount = 0;
                try {
                    const productsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'products'));
                    productsSnap.forEach(doc => { batch.delete(doc.ref); deletedCount++; });
                    const reportsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'weekly_reports'));
                    reportsSnap.forEach(doc => { batch.delete(doc.ref); deletedCount++; });
                    await batch.commit();
                    setMsgModal({ title: "é‡ç½®æˆåŠŸ", message: `ç³»çµ±å·²é‡ç½®ï¼å…±åˆªé™¤äº† ${deletedCount} ç­†è³‡æ–™ã€‚\nç¾åœ¨æ‚¨å¯ä»¥é‡æ–°åŒ¯å…¥ä¹¾æ·¨çš„ç”¢å“èˆ‡é€²è²¨å–®ã€‚`, type: "success" });
                } catch (e) {
                    setMsgModal({ title: "é‡ç½®å¤±æ•—", message: e.message, type: "error" });
                }
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {msgModal && <MessageModal {...msgModal} onClose={() => setMsgModal(null)} />}
                    {modalConfig && <ConfirmModal {...modalConfig} onCancel={() => setModalConfig(null)} />}
                    <div className="md:col-span-2 bg-white rounded-lg shadow p-6">
                        <h3 className="font-bold text-lg mb-4 flex items-center"><Users className="mr-2"/> å¸³è™Ÿåˆ—è¡¨</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100"><tr><th className="p-3">å¸³è™Ÿ</th><th className="p-3">åç¨±</th><th className="p-3">ERP</th><th className="p-3">æ“ä½œ</th></tr></thead>
                                <tbody className="divide-y">{accounts.map(acc => (
                                    <tr key={acc.username} className="hover:bg-gray-50">
                                        <td className="p-3 font-bold">{acc.username}</td><td className="p-3">{acc.name}</td><td className="p-3 font-mono">{acc.erp_code}</td>
                                        <td className="p-3"><button onClick={() => handleEdit(acc)} className="text-blue-600 mr-2">ç·¨è¼¯</button>{acc.username !== 'admin' && <button onClick={() => confirmDelete(acc.username)} className="text-red-600">åˆªé™¤</button>}</td>
                                    </tr>
                                ))}</tbody>
                            </table>
                        </div>
                        <div className="mt-8 pt-4 border-t border-gray-200">
                            <button onClick={confirmResetSystem} className="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded flex items-center w-full justify-center hover:bg-red-100"><Trash2 className="mr-2" size={18}/> ğŸ”¥ é‡ç½®ç³»çµ±è³‡æ–™ (åªä¿ç•™å¸³è™Ÿ)</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6 h-fit sticky top-24">
                        <h3 className="font-bold text-lg mb-4">{isEditing ? 'ç·¨è¼¯' : 'æ–°å¢'}å¸³è™Ÿ</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full border p-2 rounded" value={formData.username} onChange={e=>setFormData({...formData, username: e.target.value})} disabled={isEditing} required placeholder="å¸³è™Ÿ" />
                            <input className="w-full border p-2 rounded" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} required placeholder="å¯†ç¢¼" />
                            <input className="w-full border p-2 rounded" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} required placeholder="åç¨±" />
                            <input className="w-full border p-2 rounded" value={formData.erp_code} onChange={e=>setFormData({...formData, erp_code: e.target.value})} placeholder="ERP ä»£è™Ÿ" />
                            <select className="w-full border p-2 rounded" value={formData.role} onChange={e=>setFormData({...formData, role: e.target.value})}><option value="dealer">ç¶“éŠ·å•†</option><option value="admin">ç®¡ç†å“¡</option></select>
                            <div className="flex gap-2">
                                {isEditing && <button type="button" onClick={()=>{setIsEditing(false);setFormData({username:'',password:'',name:'',erp_code:'',role:'dealer'})}} className="flex-1 border py-2 rounded">å–æ¶ˆ</button>}
                                <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded">{isEditing?'æ›´æ–°':'æ–°å¢'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ImportManager = ({ weekStr, products, accounts }) => {
            const [parsedPreview, setParsedPreview] = useState([]);
            const [encoding, setEncoding] = useState('Big5');
            const [msgModal, setMsgModal] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);
            const [status, setStatus] = useState('');
            const [debugDealerId, setDebugDealerId] = useState('');

            // Mappings
            const erpMap = useMemo(() => {
                const map = {};
                accounts.forEach(acc => { if (acc.erp_code) map[cleanKey(acc.erp_code)] = acc.username; });
                return map;
            }, [accounts]);

            // KEY CHANGE: Map Internal Code -> Product ID (which is also Internal Code)
            const internalCodeMap = useMemo(() => {
                const map = {};
                products.forEach(p => {
                    // Map Internal Code (A Col) to Product Object
                    if(p.internal_code) map[cleanKey(p.internal_code)] = p;
                });
                return map;
            }, [products]);

            const parseCSV = (text) => {
                const lines = text.split(/\r\n|\n/).filter(l=>l.trim());
                const delimiter = lines[0].includes('\t') ? '\t' : ',';
                const result = [];
                let unmatched = [];
                
                // 111111111.xlsx Structure:
                // Col 3 (D) = Customer Code
                // Col 8 (I) = Product Code (matches Internal Code A in WSR)
                // Col 12 (M) = Qty
                
                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(delimiter).map(s=>s.trim().replace(/^"|"$/g, ''));
                    const custCode = cleanKey(cols[3]); // D
                    const prodCode = cleanKey(cols[8]); // I (Internal)
                    const qty = parseFloat(cols[12]) || 0; // M

                    if(custCode && prodCode && qty > 0) {
                        const dealerId = erpMap[custCode];
                        const product = internalCodeMap[prodCode]; // Lookup by Internal Code
                        
                        if(dealerId && product) {
                            // Use product.id (which is generated from Internal Code) as the DB Key
                            result.push({ dealerId, productKey: product.id, qty, dealerName: custCode, prodName: product.chn_title, prodCode });
                        } else {
                            if (!dealerId) unmatched.push(`æœªçŸ¥çš„å®¢æˆ¶ä»£è™Ÿ: ${custCode}`);
                            if (!product) unmatched.push(`æœªçŸ¥çš„ç”¢å“ä»£è™Ÿ(æ–™è™Ÿ): ${prodCode}`);
                        }
                    }
                }
                setParsedPreview(result);
                setStatus(`âœ… è§£æå®Œæˆï¼š${result.length} ç­†æœ‰æ•ˆè³‡æ–™ (å·²å°æ‡‰è‡³ç”¢å“ID)`);
                if(unmatched.length > 0) setMsgModal({title: 'éƒ¨åˆ†è³‡æ–™ç„¡æ³•å°æ‡‰', message: Array.from(new Set(unmatched)).join('\n'), type: 'error'});
            };

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => parseCSV(ev.target.result);
                    r.readAsText(f, encoding);
                }
            };

            const doImport = async () => {
                const batch = writeBatch(db);
                const updates = {};
                parsedPreview.forEach(p => {
                    if(!updates[p.dealerId]) updates[p.dealerId] = {};
                    updates[p.dealerId][p.productKey] = (updates[p.dealerId][p.productKey] || 0) + p.qty;
                });

                for(const dId in updates) {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${weekStr}_${dId}`);
                    const payload = { dealerId: dId, week: weekStr, updatedAt: new Date().toISOString() };
                    for(const pKey in updates[dId]) {
                        payload[`items.${pKey}.in`] = updates[dId][pKey];
                    }
                    batch.set(ref, payload, { merge: true });
                }
                await batch.commit();
                setMsgModal({title: 'æˆåŠŸ', message: `æˆåŠŸåŒ¯å…¥ ${parsedPreview.length} ç­†è³‡æ–™åˆ°é€±æ¬¡ [${weekStr}]`, type: 'success'});
            };

            const clearWeekData = async () => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'weekly_reports'), where('week', '==', weekStr));
                const snaps = await getDocs(q);
                const batch = writeBatch(db);
                let count = 0;
                snaps.forEach(snap => {
                    const d = snap.data();
                    if(!d.items) return;
                    const up = {};
                    Object.keys(d.items).forEach(k => { if(d.items[k].in !== 0) up[`items.${k}.in`] = 0; });
                    if(Object.keys(up).length > 0) { batch.update(snap.ref, up); count++; }
                });
                await batch.commit();
                setMsgModal({ title: 'å·²æ¸…ç©º', message: `å·²é‡ç½® ${count} ä½ç¶“éŠ·å•†çš„æœ¬é€±é€²è²¨æ•¸æ“šã€‚`, type: 'success' });
            };

            const checkDB = async () => {
                if(!debugDealerId) return alert('è«‹è¼¸å…¥ç¶“éŠ·å•†ä»£è™Ÿ');
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${weekStr}_${debugDealerId}`);
                const snap = await getDoc(ref);
                if(!snap.exists()) {
                    setMsgModal({title: 'æŸ¥ç„¡è³‡æ–™', message: `é€±æ¬¡ [${weekStr}] ç¶“éŠ·å•† [${debugDealerId}] æ²’æœ‰ä»»ä½•å ±è¡¨æ–‡ä»¶ã€‚`, type: 'error'});
                } else {
                    const data = snap.data();
                    const items = data.items || {};
                    const content = Object.keys(items)
                        .filter(k => items[k].in > 0)
                        .map(k => `Key(æ–™è™Ÿ): ${k} => IN: ${items[k].in}`)
                        .join('\n');
                    setMsgModal({title: 'è³‡æ–™åº«åŸå§‹å…§å®¹', message: content || 'è©²ç¶“éŠ·å•†æœ¬é€±æ²’æœ‰é€²è²¨æ•¸æ“š (IN=0)', type: 'info'});
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow">
                    {msgModal && <MessageModal {...msgModal} onClose={()=>setMsgModal(null)} />}
                    {modalConfig && <ConfirmModal {...modalConfig} onCancel={()=>setModalConfig(null)} />}
                    <h3 className="font-bold text-lg mb-4 flex items-center"><Upload className="mr-2"/> é€²è²¨åŒ¯å…¥ ({weekStr})</h3>
                    
                    <div className="flex gap-4 mb-4">
                         <div className="flex-1">
                            <label className="block text-sm font-medium mb-1">1. ä¸Šå‚³ CSV (éŠ·è²¨å–®)</label>
                            <div className="flex gap-2">
                                <select value={encoding} onChange={e=>setEncoding(e.target.value)} className="border rounded p-2"><option value="Big5">Big5</option><option value="UTF-8">UTF-8</option></select>
                                <input type="file" onChange={handleFile} className="border p-1 rounded flex-1" />
                            </div>
                            <div className="mt-2 text-sm text-blue-600">{status}</div>
                         </div>
                         <div className="flex-1 flex flex-col justify-end gap-2">
                            <button onClick={()=>setModalConfig({title:'æ¸…ç©ºç¢ºèª', message:'ç¢ºå®šæ¸…ç©ºæœ¬é€±æ‰€æœ‰é€²è²¨æ•¸æ“šï¼Ÿ', confirmColor:'red', onConfirm:()=>{setModalConfig(null); clearWeekData();}})} className="bg-red-100 text-red-600 p-2 rounded flex items-center justify-center hover:bg-red-200"><Eraser size={16} className="mr-2"/> ğŸ”´ å¼·åˆ¶æ¸…ç©ºæœ¬é€±é€²è²¨</button>
                            <button onClick={doImport} disabled={parsedPreview.length===0} className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50">ç¢ºèªå¯«å…¥è³‡æ–™åº«</button>
                         </div>
                    </div>

                    <div className="border-t pt-4 mt-4">
                        <label className="block text-sm font-bold mb-2 flex items-center"><Terminal size={16} className="mr-2"/> ğŸ” æª¢æŸ¥è³‡æ–™åº«åŸå§‹å…§å®¹ (Debug ç”¨)</label>
                        <div className="flex gap-2">
                            <input className="border p-2 rounded flex-1" placeholder="è¼¸å…¥ç¶“éŠ·å•†å¸³è™Ÿ (ä¾‹å¦‚: M25057155)" value={debugDealerId} onChange={e=>setDebugDealerId(e.target.value)} />
                            <button onClick={checkDB} className="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700">æª¢æŸ¥</button>
                        </div>
                    </div>
                    
                    {parsedPreview.length > 0 && (
                        <div className="mb-4 h-40 overflow-auto border rounded bg-gray-50 p-2 text-sm">
                            <table className="w-full">
                                <thead><tr><th className="text-left">ç¶“éŠ·å•†</th><th className="text-left">ç”¢å“ä»£è™Ÿ (Iæ¬„) -> Key(æ–™è™Ÿ)</th><th className="text-right">æ•¸é‡</th></tr></thead>
                                <tbody>
                                    {parsedPreview.map((p,i) => (
                                        <tr key={i} className="border-b">
                                            <td>{p.dealerName}</td>
                                            <td>{p.prodCode} -> <span className="font-bold text-blue-600">{p.productKey}</span><br/><span className="text-gray-500 text-xs">{p.prodName}</span></td>
                                            <td className="text-right font-bold text-green-600">{p.qty}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const ProductImportPanel = ({ onClose }) => {
            const [encoding, setEncoding] = useState('Big5');

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => parse(ev.target.result);
                    r.readAsText(f, encoding);
                }
            };

            const parse = async (txt) => {
                const lines = txt.split(/\r\n|\n/).filter(l=>l.trim());
                const delimiter = lines[0].includes('\t') ? '\t' : ',';
                const batch = writeBatch(db);
                let count = 0;

                // WSR.csv: 
                // Col 0 (A) = Internal Code (C20...) -> MAIN KEY
                // Col 8 (I) = P/N (CFI...)
                // Col 9 (J) = SAP P/N
                // Col 12 (M) = POS
                lines.slice(1).forEach((l, idx) => {
                    const c = l.split(delimiter).map(s => s.trim().replace(/^"|"$/g, ''));
                    const internal = cleanStr(c[0]);
                    const pn = cleanStr(c[8]);
                    const sap = cleanStr(c[9]);
                    const pos = cleanStr(c[12]);
                    
                    // KEY LOGIC: Internal Code ONLY. Fallback to PN if missing.
                    const docId = generateProductKey(internal, pos, pn);

                    if(docId !== 'UNKNOWN_KEY') {
                        const data = {
                            id: docId,
                            internal_code: internal,
                            type: cleanStr(c[5]), // New: TYPE
                            model: cleanStr(c[6]), // New: Model
                            model2: cleanStr(c[7]), // New: Model2
                            pn: pn,
                            sap_pn: cleanStr(c[9]),
                            title: cleanStr(c[10]),
                            chn_title: cleanStr(c[11]),
                            pos_code: pos,
                            eight_d_code: cleanStr(c[13]), // New: 8D Code
                            sortOrder: idx+1,
                            isActive: true
                        };
                        batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'products', docId), data);
                        count++;
                    }
                });
                await batch.commit();
                alert(`åŒ¯å…¥å®Œæˆï¼å»ºç«‹ ${count} ç­†ç”¢å“ã€‚KEY çµ±ä¸€ç‚ºï¼šæ–™è™Ÿ (Internal Code)`);
                onClose();
            };

            return (
                <div className="bg-gray-50 p-4 mb-4 rounded border">
                    <h4 className="font-bold mb-2">ç”¢å“è³‡æ–™åŒ¯å…¥ (Key = æ–™è™Ÿ)</h4>
                    <div className="flex gap-2">
                        <select value={encoding} onChange={e=>setEncoding(e.target.value)} className="border rounded"><option value="Big5">Big5</option><option value="UTF-8">UTF-8</option></select>
                        <input type="file" onChange={handleFile} />
                    </div>
                </div>
            );
        };

        const ProductManager = ({ products }) => {
            const [viewMode, setViewMode] = useState('list');
            return (
                <div>
                    {viewMode === 'import' && <ProductImportPanel onClose={()=>setViewMode('list')} />}
                    <div className="bg-white p-4 rounded shadow mb-4 flex justify-between items-center">
                        <h3 className="font-bold">ç”¢å“è³‡æ–™åº« ({products.length})</h3>
                        <button onClick={()=>setViewMode('import')} className="bg-blue-600 text-white px-3 py-1 rounded">Excel åŒ¯å…¥</button>
                    </div>
                    <div className="bg-white rounded shadow overflow-auto h-[600px]">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 sticky top-0"><tr><th className="p-2">æ–™è™Ÿ (Key)</th><th className="p-2">P/N</th><th className="p-2">å“å</th><th className="p-2">POS</th></tr></thead>
                            <tbody>
                                {products.map(p => (
                                    <tr key={p.id} className="border-b">
                                        <td className="p-2 text-blue-600 font-bold">{p.id}</td>
                                        <td className="p-2">{p.pn}</td>
                                        <td className="p-2">{p.chn_title}</td>
                                        <td className="p-2">{p.pos_code}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Component: Summary Report (Updated) ---
        const SummaryReport = ({ weekStr, products, year, week }) => {
            const [summary, setSummary] = useState({});
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'weekly_reports'),
                    where('week', '==', weekStr)
                );
                
                const unsub = onSnapshot(q, (snapshot) => {
                    const totals = {};
                    products.forEach(p => {
                        totals[p.id] = { in: 0, out: 0, stock: 0, bs: 0 };
                    });

                    snapshot.docs.forEach(doc => {
                        const data = normalizeReportData(doc.data());
                        Object.keys(data).forEach(prodKey => {
                            if (totals[prodKey]) {
                                const item = data[prodKey];
                                const inQty = (item.in || 0);
                                const outQty = (item.out || 0);
                                const bsQty = (item.bs || 0);
                                const stockQty = bsQty + inQty - outQty;

                                totals[prodKey].bs += bsQty;
                                totals[prodKey].in += inQty;
                                totals[prodKey].out += outQty;
                                totals[prodKey].stock += stockQty;
                            }
                        });
                    });
                    setSummary(totals);
                    setLoading(false);
                });
                return () => unsub();
            }, [weekStr, products]);

            const exportCSV = () => {
                // Prepare Headers
                const headers = [
                    "Year", "Month", "WK", "Date", 
                    "TYPE", "Model", "Model2", "P/N", "SAP P/N", 
                    "TITLE", "CHN TITLE", "POS", "8D Code", 
                    "Customer category", "Customer type", "Customer", 
                    "B/S", "IN", "OUT", "STOCK"
                ];

                // Prepare Data Rows
                const month = getMonthFromWeek(week, year);
                const wkStr = `WK${week}`;
                const dateRange = getDateRangeOfWeek(week, year);

                const rows = products.map(p => {
                    const s = summary[p.id] || { bs: 0, in: 0, out: 0, stock: 0 };
                    return [
                        // Removed p.internal_code || p.id, // æ–™è™Ÿ
                        year,                    // Year
                        month,                   // Month
                        wkStr,                   // WK
                        dateRange,               // Date
                        p.type || "",            // TYPE
                        p.model || "",           // Model
                        p.model2 || "",          // Model2
                        p.pn || "",              // P/N
                        p.sap_pn || "",          // SAP P/N
                        p.title || "",           // TITLE
                        p.chn_title || "",       // CHN TITLE
                        p.pos_code || "",        // POS
                        p.eight_d_code || "",    // 8D Code
                        "AGM",                   // Customer category (Hardcoded based on WSR999 sample)
                        "",                      // Customer type
                        "",                      // Customer
                        s.bs,                    // B/S
                        s.in,                    // IN
                        s.out,                   // OUT
                        s.stock                  // STOCK
                    ].map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(','); // CSV Escaping
                });

                const csvContent = "\uFEFF" + [headers.join(','), ...rows].join('\n'); // Add BOM for Excel
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `WSR_Summary_${weekStr}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="bg-white rounded shadow flex flex-col h-[calc(100vh-200px)]">
                    <div className="p-4 border-b bg-blue-50 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <h2 className="font-bold text-lg flex items-center text-blue-800"><Sigma className="mr-2"/> é€²éŠ·å½™ç¸½å ±è¡¨ ({weekStr})</h2>
                        </div>
                        <div className="flex gap-2">
                            {loading && <div className="text-sm text-blue-600 flex items-center"><Loader2 className="animate-spin mr-1" size={14}/> è¨ˆç®—ä¸­...</div>}
                            <button onClick={exportCSV} className="bg-green-600 text-white px-3 py-1 rounded flex items-center hover:bg-green-700 shadow-sm">
                                <Download size={16} className="mr-2" /> åŒ¯å‡º WSR CSV
                            </button>
                        </div>
                    </div>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-gray-100 sticky top-0 shadow-sm">
                                <tr>
                                    <th className="p-2 border-r w-28">POS</th>
                                    <th className="p-2 border-r w-32">P/N</th>
                                    <th className="p-2 min-w-[200px]">ç”¢å“åç¨±</th>
                                    <th className="p-2 w-24 text-right bg-blue-50 font-bold">ç¸½æœŸåˆ (B/S)</th>
                                    <th className="p-2 w-24 text-right bg-green-100 font-bold">ç¸½é€²è²¨ (IN)</th>
                                    <th className="p-2 w-24 text-right bg-yellow-100 font-bold">ç¸½éŠ·è²¨ (OUT)</th>
                                    <th className="p-2 w-24 text-right bg-gray-200 font-bold">ç¸½åº«å­˜ (STOCK)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {products.map(p => {
                                    const s = summary[p.id] || { bs: 0, in: 0, out: 0, stock: 0 };
                                    return (
                                        <tr key={p.id} className="hover:bg-gray-50 border-b">
                                            <td className="p-2 border-r font-mono text-xs">{p.pos_code}</td>
                                            <td className="p-2 border-r font-mono text-xs">{p.pn}</td>
                                            <td className="p-2 text-xs">{p.chn_title}</td>
                                            <td className="p-2 text-right bg-blue-50 font-mono font-bold text-blue-800">{s.bs}</td>
                                            <td className="p-2 text-right bg-green-50 font-mono font-bold text-green-700">{s.in}</td>
                                            <td className="p-2 text-right bg-yellow-50 font-mono font-bold text-yellow-700">{s.out}</td>
                                            <td className="p-2 text-right bg-gray-100 font-mono font-bold text-gray-800">{s.stock}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- New Component: Submission Status Panel ---
        const SubmissionStatusPanel = ({ weekStr, accounts, onSelectDealer }) => {
            const [reportStatuses, setReportStatuses] = useState({});
            const [loading, setLoading] = useState(true);

            const dealerAccounts = useMemo(() => accounts.filter(a => a.role === 'dealer'), [accounts]);

            useEffect(() => {
                setLoading(true);
                // Fetch ALL reports for the week to check statuses
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'weekly_reports'),
                    where('week', '==', weekStr)
                );
                
                const unsub = onSnapshot(q, (snapshot) => {
                    const statuses = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.dealerId) {
                            statuses[data.dealerId] = {
                                status: data.status, // 'submitted' or undefined
                                submittedAt: data.submittedAt
                            };
                        }
                    });
                    setReportStatuses(statuses);
                    setLoading(false);
                });
                return () => unsub();
            }, [weekStr]);

            return (
                <div className="bg-white p-6 rounded-lg shadow h-[calc(100vh-200px)] overflow-auto">
                    <h2 className="font-bold text-lg mb-4 flex items-center"><ClipboardList className="mr-2"/> é€±å ±ç¹³äº¤ç‹€æ³ ({weekStr})</h2>
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-100 sticky top-0">
                            <tr>
                                <th className="p-3">ç¶“éŠ·å•†</th>
                                <th className="p-3">ERP ä»£ç¢¼</th>
                                <th className="p-3">ç¹³äº¤ç‹€æ…‹</th>
                                <th className="p-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {dealerAccounts.map(dealer => {
                                const info = reportStatuses[dealer.username];
                                const isSubmitted = info?.status === 'submitted';
                                return (
                                    <tr key={dealer.username} className="hover:bg-gray-50">
                                        <td className="p-3 font-bold">{dealer.name} <span className="text-xs text-gray-400 font-normal">({dealer.username})</span></td>
                                        <td className="p-3 font-mono">{dealer.erp_code}</td>
                                        <td className="p-3">
                                            {isSubmitted ? (
                                                <span className="inline-flex items-center text-green-700 bg-green-100 px-2 py-1 rounded text-xs font-bold">
                                                    <CheckCircle size={14} className="mr-1"/> å·²é€å‡º ({new Date(info.submittedAt).toLocaleDateString()})
                                                </span>
                                            ) : (
                                                <span className="inline-flex items-center text-red-700 bg-red-100 px-2 py-1 rounded text-xs font-bold">
                                                    <XCircle size={14} className="mr-1"/> æœªé€å‡º
                                                </span>
                                            )}
                                        </td>
                                        <td className="p-3 text-right">
                                            <button 
                                                onClick={() => onSelectDealer(dealer.username)}
                                                className="text-blue-600 hover:text-blue-800 underline"
                                            >
                                                æŸ¥çœ‹å ±è¡¨
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        const WeeklyReport = ({ user, weekStr, products, year, week, dealers, isAdmin }) => {
            const [report, setReport] = useState({});
            const [prevReport, setPrevReport] = useState({}); // New State: Previous week data
            const [targetDealer, setTargetDealer] = useState(isAdmin ? '' : user.uid);
            const [reportStatus, setReportStatus] = useState(null); 
            const [snapshotError, setSnapshotError] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);
            
            const [docExists, setDocExists] = useState(false);
            const [rawData, setRawData] = useState(null);

            useEffect(() => {
                if(isAdmin && dealers.length > 0 && !targetDealer) setTargetDealer(dealers[0].username);
            }, [dealers, isAdmin]);

            // Effect: Fetch Current Week Data
            useEffect(() => {
                if(!targetDealer) return;
                setSnapshotError(null);
                setReport({}); 
                setRawData(null); 
                setDocExists(false);
                setReportStatus(null);
                
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${weekStr}_${targetDealer}`), 
                    (snap) => {
                        setDocExists(snap.exists());
                        if (snap.exists()) {
                            const data = snap.data();
                            setRawData(data);
                            setReportStatus(data.status);
                            const normalizedItems = normalizeReportData(data);
                            setReport(normalizedItems);
                        } else {
                            setReport({});
                            setReportStatus(null);
                            setRawData(null);
                        }
                    },
                    (err) => {
                        console.error("Snapshot Error:", err);
                        setSnapshotError(err.message);
                    }
                );
                return () => unsub();
            }, [weekStr, targetDealer]);

            // New Effect: Fetch Previous Week Data for B/S
            useEffect(() => {
                if(!targetDealer || !weekStr) return;
                const prevWeekStr = getPrevWeekStr(weekStr);
                
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${prevWeekStr}_${targetDealer}`), 
                    (snap) => {
                        if (snap.exists()) {
                            const data = normalizeReportData(snap.data());
                            setPrevReport(data);
                        } else {
                            setPrevReport({});
                        }
                    }
                );
                return () => unsub();
            }, [weekStr, targetDealer]);

            const isLocked = !isAdmin && reportStatus === 'submitted';

            const ghostData = useMemo(() => {
                const productKeys = new Set(products.map(p => p.id));
                return Object.keys(report).filter(k => (report[k].in > 0 || report[k].stock > 0) && !productKeys.has(k));
            }, [report, products]);

            const updateVal = async (key, field, val) => {
                if (isLocked) return; 
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${weekStr}_${targetDealer}`);
                const payload = { dealerId: targetDealer, week: weekStr, [`items.${key}.${field}`]: parseFloat(val)||0 };
                await setDoc(ref, payload, { merge: true });
            };

            const handleSubmitReport = () => {
                setModalConfig({
                    title: "ç¢ºèªé€å‡ºé€±å ±",
                    message: "é€å‡ºå¾Œè³‡æ–™å°‡è¢«é–å®šï¼Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ã€‚\nè‹¥éœ€ä¿®æ”¹è«‹è¯ç¹«ç®¡ç†å“¡ã€‚\n\nç¢ºå®šè¦é€å‡ºæœ¬é€±å ±è¡¨å—ï¼Ÿ",
                    onConfirm: async () => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'weekly_reports', `report_${weekStr}_${targetDealer}`);
                        await setDoc(ref, { 
                            dealerId: targetDealer, 
                            week: weekStr, 
                            status: 'submitted', 
                            submittedAt: new Date().toISOString() 
                        }, { merge: true });
                        setModalConfig(null);
                    },
                    confirmText: "ç¢ºèªé€å‡º"
                });
            };

            // Enhanced change handler for OUT validation and Admin warning
            const handleOutChange = (prodKey, valStr, maxStock) => {
                const newVal = valStr === '' ? 0 : parseFloat(valStr);
                
                if (newVal < 0) return; // Prevent negative inputs
                if (newVal > maxStock) {
                    alert(`éŒ¯èª¤ï¼šéŠ·è²¨æ•¸é‡ (${newVal}) ä¸èƒ½è¶…éå¯éŠ·å”®åº«å­˜ (${maxStock})\n\nå¯éŠ·å”®åº«å­˜ = æœŸåˆåº«å­˜ (B/S) + æœ¬é€±é€²è²¨ (IN)`);
                    return;
                }

                if (isAdmin) {
                    if (confirm(`ç®¡ç†è€…ç¢ºèªï¼š\næ‚¨ç¢ºå®šè¦ä¿®æ”¹æ­¤ OUT æ¬„ä½å—ï¼Ÿ`)) {
                        updateVal(prodKey, 'out', newVal);
                    }
                } else {
                    updateVal(prodKey, 'out', newVal);
                }
            };

            const dbPath = `artifacts/${appId}/public/data/weekly_reports/report_${weekStr}_${targetDealer}`;
            const currentUser = getAuth(initializeApp(firebaseConfig)).currentUser;

            if(products.length === 0) return <div className="p-8 text-center">è«‹å…ˆåŒ¯å…¥ç”¢å“è³‡æ–™åº«</div>;

            return (
                <div className="bg-white rounded shadow flex flex-col h-[calc(100vh-200px)]">
                    {modalConfig && <ConfirmModal {...modalConfig} onCancel={()=>setModalConfig(null)} />}
                    
                    {/* Add Debug Section for Admin */}
                    {isAdmin && (
                         <div className="bg-gray-100 p-2 text-xs border-b border-gray-300 font-mono text-gray-600 break-all hidden">
                            <span className="font-bold text-red-600">[DEBUG]</span> <br/>
                            <span className="font-bold">Auth:</span> {currentUser ? (currentUser.isAnonymous ? 'Anon' : 'User') : 'No'} | 
                            <span className="font-bold"> Path:</span> {dbPath} | 
                            <span className="font-bold"> Status:</span> {reportStatus || 'Draft'}
                         </div>
                    )}

                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <div className="flex items-center gap-2">
                            <h2 className="font-bold text-lg">é€±å ±è¡¨å¡«å¯«</h2>
                            {isAdmin && <select value={targetDealer} onChange={e=>setTargetDealer(e.target.value)} className="border rounded p-1">{dealers.map(d=><option key={d.username} value={d.username}>{d.name}</option>)}</select>}
                        </div>
                        
                        <div className="flex items-center gap-2">
                            {reportStatus === 'submitted' ? (
                                <div className={`flex items-center px-3 py-1 rounded text-sm font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-200 text-gray-600'}`}>
                                    {isAdmin ? <><UserCog size={16} className="mr-1"/> ç®¡ç†å“¡ä¿®æ­£æ¨¡å¼ (å·²é€å‡º)</> : <><Lock size={16} className="mr-1"/> å·²é€å‡º (å”¯è®€)</>}
                                </div>
                            ) : (
                                !isAdmin && (
                                    <button 
                                        onClick={handleSubmitReport}
                                        className="bg-blue-600 text-white px-4 py-2 rounded flex items-center hover:bg-blue-700 shadow-sm transition-all animate-pulse"
                                    >
                                        <Send size={16} className="mr-2" /> é€å‡ºè³‡æ–™
                                    </button>
                                )
                            )}
                        </div>
                    </div>

                    {ghostData.length > 0 && (
                        <div className="bg-yellow-100 p-2 text-xs text-yellow-800">
                            <div className="font-bold flex items-center"><AlertCircle size={14} className="mr-1"/> ç™¼ç¾å¹½éˆæ•¸æ“š (Key ä¸åŒ¹é…):</div>
                            {ghostData.map(k => <span key={k} className="mr-2">{k}: IN={report[k].in}</span>)}
                        </div>
                    )}
                    
                    <div className="overflow-auto flex-1 relative">
                        {/* Overlay when locked for dealer */}
                        {isLocked && <div className="absolute inset-0 z-10 bg-gray-50/30 cursor-not-allowed" title="è³‡æ–™å·²é€å‡ºï¼Œç„¡æ³•ä¿®æ”¹"></div>}
                        
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-gray-100 sticky top-0 shadow-sm z-20">
                                <tr>
                                    {/* HIDDEN: <th className="p-2 border-r w-28">æ–™è™Ÿ (Key)</th> */}
                                    <th className="p-2 border-r w-28">POS</th>
                                    <th className="p-2 border-r w-32">P/N</th>
                                    <th className="p-2 min-w-[200px]">ç”¢å“åç¨±</th>
                                    <th className="p-2 w-20 text-right bg-blue-50 font-bold">B/S (æœŸåˆ)</th>
                                    <th className="p-2 w-20 text-right bg-green-50">IN</th>
                                    <th className="p-2 w-20 text-right bg-yellow-50">OUT</th>
                                    <th className="p-2 w-20 text-right bg-gray-100">STOCK</th>
                                </tr>
                            </thead>
                            <tbody>
                                {products.map(p => {
                                    const r = report[p.id] || {};
                                    
                                    // Calculate B/S from Previous Week
                                    const prevItem = prevReport[p.id] || {bs:0, in:0, out:0};
                                    // Previous Stock = Prev BS + Prev IN - Prev OUT
                                    const calculatedBS = (prevItem.bs || 0) + (prevItem.in || 0) - (prevItem.out || 0);
                                    
                                    // If current report has explicit BS saved (optional future feature), use it, otherwise use calculated
                                    const currentBS = r.bs !== undefined ? r.bs : calculatedBS;
                                    
                                    const currentIn = r.in || 0;
                                    const currentOut = r.out || 0;
                                    const currentStock = currentBS + currentIn - currentOut;
                                    const maxStock = currentBS + currentIn; // Max allowable OUT

                                    return (
                                        <tr key={p.id} className="hover:bg-gray-50 border-b">
                                            {/* HIDDEN: <td className="p-2 border-r font-mono text-blue-700 text-xs">{p.id}</td> */}
                                            <td className="p-2 border-r font-mono text-xs">{p.pos_code}</td>
                                            <td className="p-2 border-r font-mono text-xs">{p.pn}</td>
                                            <td className="p-2 text-xs">{p.chn_title}</td>
                                            
                                            {/* B/S Column */}
                                            <td className="p-2 text-right bg-blue-50 font-mono text-blue-800 font-bold">
                                                {currentBS}
                                            </td>

                                            <td className={`p-2 text-right bg-green-50 font-mono ${r.in>0?'text-green-700 font-bold':''}`}>{currentIn||'-'}</td>
                                            
                                            <td className="p-2 bg-yellow-50">
                                                <input 
                                                    type="number" 
                                                    disabled={isLocked}
                                                    className="w-full text-right bg-transparent disabled:text-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 rounded px-1" 
                                                    placeholder="0" 
                                                    value={r.out||''} 
                                                    onChange={e => handleOutChange(p.id, e.target.value, maxStock)}
                                                />
                                            </td>
                                            
                                            <td className="p-2 text-right bg-gray-100 font-mono font-bold">{currentStock}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [week, setWeek] = useState(getWeekNumber(INITIAL_DATE));
            const [products, setProducts] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [view, setView] = useState('report');
            const [firebaseReady, setFirebaseReady] = useState(false);
            const weekStr = getWeekString(week.year, week.week);

            // 1. Initial Auth Check (Standard for this Environment)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.warn("Anonymous auth failed (this is expected if you haven't enabled it in Firebase Console):", e);
                    }
                    setFirebaseReady(true);
                };
                initAuth();
            }, []);
            
            // 2. Data Subscriptions (Only after user is logged into the APP level)
            useEffect(() => {
                if(!user) return;
                const unsub1 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'products')), s => {
                    setProducts(s.docs.map(d=>({id: d.id, ...d.data()})).sort((a,b)=>a.sortOrder-b.sortOrder));
                });
                const unsub2 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'accounts')), s => {
                    setAccounts(s.docs.map(d=>({id: d.id, ...d.data()})));
                });
                return () => { unsub1(); unsub2(); };
            }, [user]);

            if (!firebaseReady) {
                 return (
                    <div className="min-h-screen bg-gray-900 flex items-center justify-center text-white">
                        <div className="flex flex-col items-center">
                            <Loader2 className="animate-spin mb-2" size={32} />
                            <div>System Initializing...</div>
                        </div>
                    </div>
                 );
            }

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 font-sans">
                    <div className="bg-black text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <div className="font-bold text-xl flex items-center">SONY WSR <span className="ml-4 text-xs font-normal bg-gray-800 px-2 py-1 rounded text-gray-300">User: {user.role==='admin'?'Admin':user.uid}</span></div>
                        <div className="flex gap-4">
                            {user.role==='admin' && (
                                <>
                                <button onClick={()=>setView('report')} className={view==='report'?'text-white':'text-gray-400'}>å–®åº—æª¢è¦–</button>
                                <button onClick={()=>setView('summary')} className={view==='summary'?'text-white':'text-gray-400'}>å½™ç¸½å ±è¡¨</button>
                                <button onClick={()=>setView('status')} className={view==='status'?'text-white':'text-gray-400'}>ç¹³äº¤ç‹€æ³</button>
                                <button onClick={()=>setView('import')} className={view==='import'?'text-white':'text-gray-400'}>é€²è²¨åŒ¯å…¥</button>
                                <button onClick={()=>setView('products')} className={view==='products'?'text-white':'text-gray-400'}>ç”¢å“è³‡æ–™åº«</button>
                                <button onClick={()=>setView('accounts')} className={view==='accounts'?'text-white':'text-gray-400'}>å¸³è™Ÿç®¡ç†</button>
                                </>
                            )}
                            <button onClick={()=>setUser(null)}>ç™»å‡º</button>
                        </div>
                    </div>
                    
                    <div className="max-w-7xl mx-auto p-4">
                        <div className="bg-white p-4 rounded shadow mb-4 flex justify-between items-center">
                             <div className="flex items-center gap-4">
                                <button onClick={()=>setWeek(w=>({...w, week: w.week-1}))} className="p-2 hover:bg-gray-100 rounded-full"><ChevronLeft/></button>
                                <div className="text-center"><div className="font-bold text-xl">{weekStr}</div><div className="text-xs text-gray-500">{getDateRangeOfWeek(week.week, week.year)}</div></div>
                                <button onClick={()=>setWeek(w=>({...w, week: w.week+1}))} className="p-2 hover:bg-gray-100 rounded-full"><ChevronRight/></button>
                             </div>
                        </div>

                        {view === 'accounts' && <AccountManager accounts={accounts} />}
                        {view === 'products' && <ProductManager products={products} />}
                        {view === 'import' && <ImportManager weekStr={weekStr} products={products} accounts={accounts} />}
                        {view === 'summary' && <SummaryReport weekStr={weekStr} products={products} year={week.year} week={week.week} />}
                        {view === 'status' && <SubmissionStatusPanel weekStr={weekStr} accounts={accounts} onSelectDealer={(dId)=>{setView('report'); /* We rely on admin changing dropdown manually in next render, or we could pass state up, but keeping it simple for now as admin panel has dropdown */ }} />} 
                        {view === 'report' && <WeeklyReport user={user} weekStr={weekStr} products={products} year={week.year} week={week.week} dealers={accounts.filter(a=>a.role==='dealer')} isAdmin={user.role==='admin'} />}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
